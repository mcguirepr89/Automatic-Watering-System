/*
Automatic Watering System
Hardware: 
OLED DISPLAY (data=A4, clock=A5)
5v RELAY (signal=D7, switching power to pump)
5v WATER PUMP
ROTARY ENCODER (a=D8, b=D2) 
SOIL SENSOR (A1)
*/

//Including Libraries
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

//Defining Hardware
//OLED
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 32
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, -1); //Declaration for an SSD1306 display connected to I2C (SDA, SCL pins)

//Relay
#define relayS 7

//Rotary Encoder
#define rotaryA 8
#define rotaryB 2

//Soil Sensor
#define analogInPin A1

//Integer Variables
int dryValue;
int counter;
int aState;
int aLastState;
int sensorValue;


//Setup in the same order as above
void setup() {
  //OLED
  Serial.begin(115200);
  if (!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) {
    Serial.println(F("SSD1306 allocation failed"));
    for (;;);
  }
  delay(2000);
  display.setRotation(2);
  display.clearDisplay();
  display.setTextColor(WHITE);
  
  //Relay
  pinMode(relayS, OUTPUT);
  
  //Rotary Encoder
  pinMode (rotaryA, INPUT);
  pinMode (rotaryB, INPUT);
  aLastState = digitalRead(rotaryA);
  attachInterrupt(digitalPinToInterrupt(rotaryB), wetset, CHANGE);
}


void loop() {
  delay(500); Just slowing shit down   
  
  dryValue = counter;//Sets whatever is set using the rotary encoder
  
  //Instantiate the soil sensor and adjust for some shit
  int t = analogRead(analogInPin) / 10 +12
  if (isnan(t)) {
    Serial.println("Failed to read soil!");
  }
  Serial.print("soil sensor = " );
  Serial.println(t);
  
  //Watering loop = set to water for 6.5 seconds; each block is .5 seconds
  if ( t <= dryValue ) {
    digitalWrite(relayS, HIGH);                       //Turn on the pump
    
    Serial.print("Soil sensor level: ");
    Serial.println(t);
    delay(500);
    display.clearDisplay();
    display.setTextSize(2);
    display.setCursor(0, 3);
    display.print("Watering");
    display.display();

    Serial.print("Soil sensor level: ");
    Serial.println(t);
    delay(500);
    display.clearDisplay();
    display.setTextSize(2);
    display.setCursor(0, 3);
    display.print("Watering.");
    display.display();

    Serial.print("Soil sensor level: ");
    Serial.println(t);
    delay(500);
    display.clearDisplay();
    display.setTextSize(2);
    display.setCursor(0, 3);
    display.print("Watering..");
    display.display();

    Serial.print("Soil sensor level: ");
    Serial.println(t);
    delay(500);
    display.clearDisplay();
    display.setTextSize(2);
    display.setCursor(0, 3);
    display.print("Watering...");
    display.display();

    Serial.print("Soil sensor level: ");
    Serial.println(t);
    delay(500);
    display.clearDisplay();
    display.setTextSize(2);
    display.setCursor(0, 3);
    display.print("Watering....");
    display.display();

    Serial.print("Soil sensor level: ");
    Serial.println(t);
    delay(500);
    display.clearDisplay();
    display.setTextSize(2);
    display.setCursor(0, 3);
    display.print("Watering.....");
    display.display();

    Serial.print("Soil sensor level: ");
    Serial.println(t);
    delay(500);
    display.clearDisplay();
    display.setTextSize(2);
    display.setCursor(0, 3);
    display.print("Watering......");
    display.display();

    Serial.print("Soil sensor level: ");
    Serial.println(t);
    delay(500);
    display.clearDisplay();
    display.setTextSize(2);
    display.setCursor(0, 3);
    display.print("Watering.......");
    display.display();

    Serial.print("Soil sensor level: ");
    Serial.println(t);
    delay(500);
    display.clearDisplay();
    display.setTextSize(2);
    display.setCursor(0, 3);
    display.print("Watering........");
    display.display();

    Serial.print("Soil sensor level: ");
    Serial.println(t);
    delay(500);
    display.clearDisplay();
    display.setTextSize(2);
    display.setCursor(0, 3);
    display.print("Watering.........");
    display.display();

    Serial.print("Soil sensor level: ");
    Serial.println(t);
    delay(500);
    display.clearDisplay();
    display.setTextSize(2);
    display.setCursor(0, 3);
    display.print("Watering..........");
    display.display();

    Serial.print("Soil sensor level: ");
    Serial.println(t);
    delay(500);
    display.clearDisplay();
    display.setTextSize(2);
    display.setCursor(0, 3);
    display.print("Watering...........");
    display.display();

    Serial.print("Soil sensor level: ");
    Serial.println(t);
    delay(500);
    display.clearDisplay();
    display.setTextSize(2);
    display.setCursor(0, 3);
    display.print("Watering............");
    display.display();
    

    digitalWrite(relayS, LOW);                           //Turn off the pump
  }


  //Watering trigger loop end


  //Normal display loop
  display.clearDisplay();
  display.setTextSize(2);
  display.setCursor(0, 3);
  display.print("Soil: ");
  display.setTextSize(2);
  display.setCursor(70, 3);
  if ( t >= 100 ) {
    display.print("100%");
  } else {
    display.print(t);
    display.print("%");
  }
  display.setTextSize(1.5);
  display.setCursor(0, 22);
  display.print("Watering trigger: ");
  display.setCursor(109, 22);
  display.print(counter);
  display.print("%");
  display.display();

  delay(1000);

  display.clearDisplay();
  display.setTextSize(2);
  display.setCursor(0, 3);
  display.print("Soil: ");
  display.setTextSize(2);
  display.setCursor(70, 3);
  if ( t >= 100 ) {
    display.print("100%");
  } else {
    display.print(t);
    display.print("%");
  }
  display.setTextSize(1.5);
  display.setCursor(0, 22);
  display.print("Watering trigger: ");
  display.setCursor(109, 22);
  display.print(counter);
  display.print("%");
  display.display();

  delay(1000);

  display.clearDisplay();
  display.setTextSize(2);
  display.setCursor(0, 3);
  display.print("Soil: ");
  display.setTextSize(2);
  display.setCursor(70, 3);
  if ( t >= 100 ) {
    display.print("100%");
  } else {
    display.print(t);
    display.print("%");
  }
  display.setTextSize(1.5);
  display.setCursor(0, 22);
  display.print("Watering trigger: ");
  display.setCursor(109, 22);
  display.print(counter);
  display.print("%");
  display.display();

  delay(1000);

}


//Wetset interrupt loop to set the 'counter' variable for the watering trigger
void wetset() {
  {
  volatile static unsigned long last_interrupt_time = 0;
  unsigned long interrupt_time = millis();
  if (interrupt_time - last_interrupt_time > 3 )  // ignores interupts for 3 milliseconds
  {
    aState = digitalRead(rotaryA);
  if (aState != aLastState) {
    if (digitalRead(rotaryB) != aState) {
      if (counter >= 1) {
        counter --;
      }
    } else {
      if (counter <= 99) {

        counter ++;
      }
    }
    Serial.print("Watering trigger: ");
    Serial.println(counter);
  }
  aLastState = aState;
  }
  last_interrupt_time = interrupt_time;
}
}
